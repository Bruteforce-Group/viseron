import TabItem from "@theme/TabItem";
import Tabs from "@theme/Tabs";
import ComponentConfiguration from "@site/src/pages/components-explorer/_components/ComponentConfiguration";
import ComponentHeader from "@site/src/pages/components-explorer/_components/ComponentHeader";
import Camera from "@site/src/pages/components-explorer/_domains/camera/index.mdx";
import CameraMjpegStreams from "@site/src/pages/components-explorer/_domains/camera/mjpeg_streams.mdx";
import ComponentMetadata from "./_meta";
import config from "./config.json";

<ComponentHeader meta={ComponentMetadata} />

FFmpeg enables Viseron to read frames from cameras.

FFmpeg can be quite complex to work with, but in most cases the automatically generated commands will fit your needs.

[Hardware acceleration](#hardware-acceleration) is available on a wide variety of systems.

## Configuration

<details>
  <summary>Configuration example</summary>

```yaml
ffmpeg:
  camera:
    camera_one:
      name: Camera 1
      host: 192.168.XX.X
      port: 554
      path: /Streaming/Channels/101/
      username: !secret camera_one_user
      password: !secret camera_one_pass
      substream:
        path: /Streaming/Channels/102/
        stream_format: rtsp
        port: 554
      mjpeg_streams:
        my_stream:
          width: 100
          height: 100
          draw_objects: true
          rotate: 45
          mirror: true
        objects:
          draw_objects: true
          draw_zones: true
          draw_motion: true
          draw_motion_mask: true
          draw_object_mask: true
      recorder:
        idle_timeout: 5
      frame_timeout: 10
```

</details>

<ComponentConfiguration meta={ComponentMetadata} config={config} />

## Camera

<Camera />

### Hardware acceleration

Viseron supports both hardware accelerated decoding and encoding.<br />
This means your CPU will be offloaded and give you a significant performance increase.

Supported hardware:

- NVIDIA GPU
- VA-API on compatible Intel CPU's
- Raspberry Pi 3
- Raspberry Pi 4
- NVIDIA Jetson Nano

Viseron will detect what system you are running and will automagically utilize the hardware acceleration.

:::warning

The Jetson Nano support is very limited in FFmpeg. If you have a Nano i suggest looking at the `gstreamer` component instead.

:::

### Default FFmpeg decoder command

A default FFmpeg decoder command is generated.
To use hardware acceleration, the command varies a bit depending on the Docker container you use.

<details open>
<summary>Commands</summary>

<Tabs groupId="hwaccel">
<TabItem value="nvidia" label="NVIDIA">

NVIDIA GPU support in the <b>roflcoopter/amd64-cuda-viseron</b> image:

```
ffmpeg -hide_banner -loglevel error -avoid_negative_ts make_zero -fflags nobuffer -flags low_delay -strict experimental -fflags +genpts -stimeout 5000000 -use_wallclock_as_timestamps 1 -vsync 0 -c:v h264_cuvid -rtsp_transport tcp -i rtsp://{username}:{password}@{host}:{port}{path} -f rawvideo -pix_fmt nv12 pipe:1
```

</TabItem>
<TabItem value="vaapi" label="VA-API">

VAAPI support in the <b>roflcoopter/viseron</b> image:

```
ffmpeg -hide_banner -loglevel error -avoid_negative_ts make_zero -fflags nobuffer -flags low_delay -strict experimental -fflags +genpts -stimeout 5000000 -use_wallclock_as_timestamps 1 -vsync 0 -hwaccel vaapi -vaapi_device /dev/dri/renderD128 -rtsp_transport tcp -i rtsp://{username}:{password}@{host}:{port}{path} -f rawvideo -pix_fmt nv12 pipe:1
```

</TabItem>
<TabItem value="rpi3" label="RPi3">

For RPi3 in the <b>roflcoopter/rpi3-viseron</b> image:

```
ffmpeg -hide_banner -loglevel error -avoid_negative_ts make_zero -fflags nobuffer -flags low_delay -strict experimental -fflags +genpts -stimeout 5000000 -use_wallclock_as_timestamps 1 -vsync 0 -c:v h264_mmal -rtsp_transport tcp -i rtsp://{username}:{password}@{host}:{port}{path} -f rawvideo -pix_fmt nv12 pipe:1
```

</TabItem>
</Tabs>

</details>

This means that you do **not** have to set `hwaccel_args` _unless_ you have a specific need to change the default command (say you need to change `h264_cuvid` to `hevc_cuvid`)

### Custom FFmpeg decoder command

You can customize the generated command through the config.
It can be a bit hard to get this right so it is not recommended unless you know what you are doing.

The command is built up like this:

```python
"ffmpeg" + global_args + input_args + hwaccel_args + codec + "-rtsp_transport tcp -i " + (stream url) + " -vf " + video_filters + output_args
```

Each entry in `video_filters` are appended together, separated with a `,`.

<details>
  <summary>Config example to rotate image 180 degrees</summary>

```yaml /config/config.yaml
ffmpeg:
  camera:
    camera_1:
    ....
      video_filters:   # These filters rotate the images processed by Viseron
        - transpose=2
        - transpose=2
      recorder:
        video_filters:   # These filters rotate the recorded video
          - transpose=2
          - transpose=2
```

And the resulting command looks like this:

```bash
ffmpeg -hide_banner -loglevel error -avoid_negative_ts make_zero -fflags nobuffer -flags low_delay -strict experimental -fflags +genpts -use_wallclock_as_timestamps 1 -vsync 0 -stimeout 5000000 -c:v h264_cuvid -rtsp_transport tcp -i rtsp://*****:*****@192.168.**.**:554/Streaming/Channels/101/ -vf transpose=2,transpose=2,fps=1.0 -f rawvideo -pix_fmt nv12 pipe:1
```

</details>

### MJEPG Streams

<CameraMjpegStreams />

### FFprobe Stream Information

Viseron needs to know the width, height, FPS and audio/video codecs of your stream.<br />
FFprobe is used on initialization to figure all this information out.

Some cameras dont play nice with this and fail to report some information.<br />
To circumvent this you can manually specify all these options.

If you specify all of `width`, `height`, `fps`, `codec` and `audio_codec`, Viseron will not need to call FFprobe and startup will be significantly faster.

### Recoverable Errors

Sometimes FFmpeg prints errors which are not fatal, such as `[h264 @ 0x55b1e115d400] error while decoding MB 0 12, bytestream 114567`.<br />
Viseron always performs a sanity check on the FFmpeg decoder command with `-loglevel fatal`.<br />
If Viseron gets stuck on an error that you believe is **not** fatal, you can add a subset of that error to `ffmpeg_recoverable_errors`.<br />
So to ignore the error above you would add this to your configuration:

```yaml
ffmpeg_recoverable_errors:
  - error while decoding MB
```

### Substream

Using the substream is a great way to reduce the system load from FFmpeg.<br />
When configured, two FFmpeg processes will spawn:<br />

- One that reads the main stream and creates segments for recordings. Codec `-c:v copy` is used so practically no resources are used.<br />
- One that reads the substream and pipes frames to Viseron for motion/object detection.

To really benefit from this you should reduce the framerate of the substream to match the lowest fps set for either motion or object detection.<br />
It is also a good idea to change the resolution to something lower than the main stream.
